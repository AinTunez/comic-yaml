<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comic Panel Layout Tester</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      padding: 30px;
    }

    .input-section, .output-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    h2 {
      color: #667eea;
      font-size: 1.5rem;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 10px;
    }

    h3 {
      color: #764ba2;
      font-size: 1.2rem;
      margin-bottom: 10px;
    }

    .example-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .example-buttons button {
      padding: 8px 16px;
      background: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .example-buttons button:hover {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    textarea {
      width: 100%;
      min-height: 300px;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      resize: vertical;
      transition: border-color 0.3s ease;
    }

    textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .options {
      display: flex;
      gap: 20px;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 6px;
    }

    .options label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .options input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    #svgContainer {
      background: #f9f9f9;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      min-height: 400px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #svgContainer svg {
      max-width: 100%;
      height: auto;
      filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
    }

    #infoPanel {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
    }

    #layoutInfo {
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      line-height: 1.6;
    }

    #layoutInfo .info-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid #e0e0e0;
    }

    #layoutInfo .info-item:last-child {
      border-bottom: none;
    }

    .multi-page-section {
      padding: 30px;
      background: #f9f9f9;
      border-top: 2px solid #e0e0e0;
    }

    #multiPageInput {
      margin-top: 15px;
      min-height: 200px;
    }

    #multiPageOutput {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .page-preview {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
    }

    .page-preview h4 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }

    .page-preview svg {
      max-width: 100%;
      height: auto;
    }

    .error-message {
      background: #fee;
      color: #c00;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #fcc;
      margin-top: 10px;
    }

    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
      }
      
      header h1 {
        font-size: 1.8rem;
      }
      
      .example-buttons {
        flex-direction: column;
      }
      
      .example-buttons button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Comic Panel Layout Tester</h1>
      <p>Enter ASCII grid layouts to visualize comic panel arrangements</p>
    </header>
    
    <div class="main-content">
      <div class="input-section">
        <h2>Layout Input</h2>
        <div class="example-buttons">
          <button onclick="loadExample('simple')">Simple Grid</button>
          <button onclick="loadExample('complex')">L-Shaped Panel</button>
          <button onclick="loadExample('splash')">Splash Page</button>
          <button onclick="loadExample('classic')">9-Panel Grid</button>
          <button onclick="loadExample('many')">30-Panel Grid</button>
        </div>
        <textarea id="layoutInput" placeholder="Enter layout here...
Example:
1122
1122
3333" oninput="debounceRender()"></textarea>
        <div class="options">
          <label>
            <input type="checkbox" id="showGrid" checked onchange="renderLayout()">
            Show Grid Lines
          </label>
          <label>
            <input type="checkbox" id="showNumbers" checked onchange="renderLayout()">
            Show Panel Numbers
          </label>
        </div>
      </div>
      
      <div class="output-section">
        <h2>Preview</h2>
        <div id="svgContainer"></div>
        <div id="infoPanel">
          <h3>Layout Info</h3>
          <div id="layoutInfo"></div>
        </div>
      </div>
    </div>
    
    <div class="multi-page-section">
      <h2>Multi-Page Layout</h2>
      <p>Test multiple pages at once (separate with "---")</p>
      <textarea id="multiPageInput" placeholder="Page 1:
123
456
---
Page 2:
1122
1122
3333" oninput="debounceRenderMulti()"></textarea>
      <div id="multiPageOutput"></div>
    </div>
  </div>

  <script>
    // Layout parser functions
    function parseLayout(layoutInput) {
      const lines = Array.isArray(layoutInput) 
        ? layoutInput 
        : layoutInput.split('\n').filter(line => line.trim());
      
      if (lines.length === 0) {
        return { grid: [], panels: [], gridWidth: 0, gridHeight: 0 };
      }
      
      // Parse as a simple character grid
      const grid = [];
      for (const line of lines) {
        // Split each line into individual characters (panel numbers)
        const chars = line.split('').filter(char => char.trim());
        if (chars.length > 0) {
          grid.push(chars);
        }
      }
      
      if (grid.length === 0) {
        return { grid: [], panels: [], gridWidth: 0, gridHeight: 0 };
      }
      
      const gridHeight = grid.length;
      const gridWidth = Math.max(...grid.map(row => row.length));
      
      // Normalize grid to ensure all rows have the same width
      const normalizedGrid = [];
      for (let y = 0; y < gridHeight; y++) {
        const row = [];
        for (let x = 0; x < gridWidth; x++) {
          row.push(grid[y] && grid[y][x] ? grid[y][x] : '');
        }
        normalizedGrid.push(row);
      }
      
      // Find all cells for each panel
      const panelCells = new Map();
      
      for (let y = 0; y < normalizedGrid.length; y++) {
        for (let x = 0; x < normalizedGrid[y].length; x++) {
          const cell = normalizedGrid[y][x];
          if (cell && cell !== '') {
            if (!panelCells.has(cell)) {
              panelCells.set(cell, []);
            }
            panelCells.get(cell).push({x, y});
          }
        }
      }
      
      // Calculate bounding boxes for each panel
      const panelPositions = [];
      for (const [panelId, cells] of panelCells.entries()) {
        if (cells.length === 0) continue;
        
        const minX = Math.min(...cells.map(c => c.x));
        const maxX = Math.max(...cells.map(c => c.x));
        const minY = Math.min(...cells.map(c => c.y));
        const maxY = Math.max(...cells.map(c => c.y));
        
        // Convert panelId to number for sorting
        let panelNumber;
        if (!isNaN(parseInt(panelId))) {
          panelNumber = parseInt(panelId);
        } else {
          // Convert letter to number (A=10, B=11, etc.)
          panelNumber = panelId.charCodeAt(0) - 55; // A=65, so A=10
        }
        
        panelPositions.push({
          panelNumber: panelNumber,
          panelId: panelId, // Keep original ID for display
          cells: cells,
          boundingBox: {
            x: minX,
            y: minY,
            width: maxX - minX + 1,
            height: maxY - minY + 1
          }
        });
      }
      
      const panels = panelPositions.sort((a, b) => a.panelNumber - b.panelNumber);
      
      return {
        grid: normalizedGrid,
        panels,
        gridWidth: gridWidth,
        gridHeight: gridHeight
      };
    }

    function renderLayoutToSVG(layout, width = 400, height = 600, options = {}) {
      const { panels, gridWidth, gridHeight } = layout;
      const { showNumbers = true, showGrid = false } = options;
      
      if (panels.length === 0) {
        return `<svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">
          <rect width="${width}" height="${height}" fill="#f0f0f0" stroke="#333" stroke-width="2"/>
          <text x="${width/2}" y="${height/2}" text-anchor="middle" font-family="Arial" font-size="14" fill="#666">No layout defined</text>
        </svg>`;
      }
      
      const padding = 10;
      const innerWidth = width - (padding * 2);
      const innerHeight = height - (padding * 2);
      const cellWidth = innerWidth / gridWidth;
      const cellHeight = innerHeight / gridHeight;
      
      let svg = `<svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">`;
      svg += `<rect width="${width}" height="${height}" fill="white"/>`;
      
      if (showGrid) {
        svg += `<g stroke="#e0e0e0" stroke-width="0.5">`;
        for (let i = 0; i <= gridWidth; i++) {
          const x = padding + (i * cellWidth);
          svg += `<line x1="${x}" y1="${padding}" x2="${x}" y2="${height - padding}"/>`;
        }
        for (let i = 0; i <= gridHeight; i++) {
          const y = padding + (i * cellHeight);
          svg += `<line x1="${padding}" y1="${y}" x2="${width - padding}" y2="${y}"/>`;
        }
        svg += `</g>`;
      }
      
      // Color palette for panels
      const colors = [
        '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', 
        '#dda0dd', '#98d8c8', '#f7dc6f', '#bb8fce', '#85c1e9',
        '#f8c471', '#82e0aa', '#f1948a', '#85c1e9', '#d7bde2'
      ];
      
      // Function to calculate luminance and determine best contrast color
      function getBestContrastColor(hexColor) {
        // Convert hex to RGB
        const r = parseInt(hexColor.slice(1, 3), 16);
        const g = parseInt(hexColor.slice(3, 5), 16);
        const b = parseInt(hexColor.slice(5, 7), 16);
        
        // Calculate relative luminance using W3C formula
        const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
        
        // Return black for light backgrounds, white for dark backgrounds
        return luminance > 0.5 ? '#000000' : '#ffffff';
      }
      
      // Function to convert panel number to label (1-9, then A-Z)
      function getPanelLabel(panelNumber) {
        if (panelNumber <= 9) {
          return panelNumber.toString();
        } else {
          // Convert to letters: 10=A, 11=B, etc.
          return String.fromCharCode(65 + (panelNumber - 10));
        }
      }
      
      for (const panel of panels) {
        // Get color for this panel (cycle through colors)
        const color = colors[(panel.panelNumber - 1) % colors.length];
        
        // Draw each cell as a simple rectangle with the panel color
        for (const cell of panel.cells) {
          const x = padding + (cell.x * cellWidth);
          const y = padding + (cell.y * cellHeight);
          const w = cellWidth;
          const h = cellHeight;
          
          svg += `<rect x="${x}" y="${y}" width="${w}" height="${h}" fill="${color}"/>`;
        }
        
        // Panel number (place at actual geometric center of the shape)
        if (showNumbers) {
          // Calculate the centroid (geometric center) of all cells
          const sumX = panel.cells.reduce((sum, cell) => sum + cell.x, 0);
          const sumY = panel.cells.reduce((sum, cell) => sum + cell.y, 0);
          const centroidX = sumX / panel.cells.length;
          const centroidY = sumY / panel.cells.length;
          
          // Convert to pixel coordinates (center of the centroid cell)
          const centerX = padding + (centroidX + 0.5) * cellWidth;
          const centerY = padding + (centroidY + 0.5) * cellHeight;
          
          const bbox = panel.boundingBox;
          const fontSize = Math.min(24, Math.min(bbox.width * cellWidth, bbox.height * cellHeight) / 3);
          
          // Get the best contrasting text color and use original panel ID for display
          const textColor = getBestContrastColor(color);
          const panelLabel = panel.panelId || getPanelLabel(panel.panelNumber);
          
          svg += `<text x="${centerX}" y="${centerY}" 
            text-anchor="middle" dominant-baseline="middle" 
            font-family="Arial" font-size="${fontSize}" font-weight="bold" fill="${textColor}">
            ${panelLabel}
          </text>`;
        }
      }
      
      svg += `<rect x="${padding}" y="${padding}" width="${innerWidth}" height="${innerHeight}" 
        fill="none" stroke="#333" stroke-width="3"/>`;
      svg += `</svg>`;
      
      return svg;
    }

    // Examples
    const examples = {
      simple: `123
456`,
      
      complex: `1122
1133
3333`,
      
      splash: `1111
1111
1111
1111`,
      
      classic: `112233
445566
778899`,
      
      many: `123456789A
BCDEFGHIJK
LMNOPQRSTU`
    };

    function loadExample(type) {
      document.getElementById('layoutInput').value = examples[type];
      renderLayout();
    }

    function renderLayout() {
      const input = document.getElementById('layoutInput').value.trim();
      const svgContainer = document.getElementById('svgContainer');
      const layoutInfo = document.getElementById('layoutInfo');
      const showGrid = document.getElementById('showGrid').checked;
      const showNumbers = document.getElementById('showNumbers').checked;
      
      if (!input) {
        svgContainer.innerHTML = '<p style="color: #999;">Enter a layout to see the preview</p>';
        layoutInfo.innerHTML = '';
        return;
      }
      
      try {
        const layout = parseLayout(input);
        const svg = renderLayoutToSVG(layout, 400, 600, { showGrid, showNumbers });
        
        svgContainer.innerHTML = svg;
        
        let infoHtml = '';
        infoHtml += `<div class="info-item"><span>Grid Size:</span><span>${layout.gridWidth} × ${layout.gridHeight}</span></div>`;
        infoHtml += `<div class="info-item"><span>Total Panels:</span><span>${layout.panels.length}</span></div>`;
        
        if (layout.panels.length > 0) {
          infoHtml += '<div style="margin-top: 10px; font-weight: bold;">Panel Details:</div>';
          for (const panel of layout.panels) {
            const bbox = panel.boundingBox;
            const cellCount = panel.cells.length;
            infoHtml += `<div class="info-item">
              <span>Panel ${panel.panelNumber}:</span>
              <span>${cellCount} cells, bbox ${bbox.width}×${bbox.height}</span>
            </div>`;
          }
        }
        
        layoutInfo.innerHTML = infoHtml;
      } catch (error) {
        svgContainer.innerHTML = `<div class="error-message">Error parsing layout: ${error.message}</div>`;
        layoutInfo.innerHTML = '';
      }
    }

    function renderMultiPages() {
      const input = document.getElementById('multiPageInput').value.trim();
      const output = document.getElementById('multiPageOutput');
      const showGrid = document.getElementById('showGrid').checked;
      const showNumbers = document.getElementById('showNumbers').checked;
      
      if (!input) {
        output.innerHTML = '<p style="color: #999; text-align: center;">Enter page layouts separated by "---"</p>';
        return;
      }
      
      const pages = input.split('---').map(p => p.trim()).filter(p => p);
      let outputHtml = '';
      
      pages.forEach((pageLayout, index) => {
        try {
          const lines = pageLayout.split('\n');
          let pageName = `Page ${index + 1}`;
          let layoutText = pageLayout;
          
          if (lines[0] && (lines[0].startsWith('Page') || lines[0].startsWith('#'))) {
            pageName = lines[0].replace(/^[#\s]+/, '').replace(/[:]*$/, '');
            layoutText = lines.slice(1).join('\n');
          }
          
          const layout = parseLayout(layoutText);
          const svg = renderLayoutToSVG(layout, 300, 450, { showGrid, showNumbers });
          
          outputHtml += `
            <div class="page-preview">
              <h4>${pageName}</h4>
              ${svg}
              <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">
                ${layout.panels.length} panels | ${layout.gridWidth}×${layout.gridHeight} grid
              </p>
            </div>
          `;
        } catch (error) {
          outputHtml += `
            <div class="page-preview">
              <h4>Page ${index + 1}</h4>
              <div class="error-message">Error: ${error.message}</div>
            </div>
          `;
        }
      });
      
      output.innerHTML = outputHtml;
    }

    // Debounce functions
    let renderTimeout, multiRenderTimeout;
    
    function debounceRender() {
      clearTimeout(renderTimeout);
      renderTimeout = setTimeout(renderLayout, 300);
    }
    
    function debounceRenderMulti() {
      clearTimeout(multiRenderTimeout);
      multiRenderTimeout = setTimeout(renderMultiPages, 300);
    }

    // Initialize
    document.getElementById('layoutInput').value = examples.simple;
    document.getElementById('multiPageInput').value = `Page 1: Opening
123
456
---
Page 2: L-Shaped Panel
1122
1133
3333
---
Page 3: Splash
1111
1111
1111
1111`;
    
    renderLayout();
    renderMultiPages();
  </script>
</body>
</html>